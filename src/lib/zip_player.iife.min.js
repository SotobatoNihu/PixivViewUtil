var ZipImagePlayer=function(){"use strict";return class{constructor(t){this.op=t,this._rescale=!1,this._URL=window.URL||window.webkitURL||window.MozURL||window.MSURL,this._Blob=window.Blob||window.WebKitBlob||window.MozBlob||window.MSBlob,this._BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,this._Uint8Array=window.Uint8Array||window.WebKitUint8Array||window.MozUint8Array||window.MSUint8Array,this._DataView=window.DataView||window.WebKitDataView||window.MozDataView||window.MSDataView,this._ArrayBuffer=window.ArrayBuffer||window.WebKitArrayBuffer||window.MozArrayBuffer||window.MSArrayBuffer,this._maxLoadAhead=0,this._URL||(this._debugLog("No URL support! Will use slower data: URLs."),this._maxLoadAhead=10),this._Blob||this._error("No Blob support"),this._Uint8Array||this._error("No Uint8Array support"),this._DataView||this._error("No DataView support"),this._ArrayBuffer||this._error("No ArrayBuffer support"),this._isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,this._loadingState=0,this._dead=!1,this._context=t.canvas.getContext("2d"),this._files={},this._frameCount=this.op.metadata.frames.length,this._trailerBytes=3e4,this._failed=!1,this._debugLog(`Frame count: ${this._frameCount}`),this._frame=0,this._loadFrame=0,this._frameImages=[],this._paused=!1,this._loadTimer=null,this._startLoad(),this.op.autoStart?this.play():this._paused=!0}_mkerr(t){return()=>{this._error(t)}}_error(t){throw this._failed=!0,Error(`ZipImagePlayer error: ${t}`)}_debugLog(t){this.op.debug&&console.log(t)}_load(t,e,i){const s=new XMLHttpRequest;if(s.addEventListener("load",()=>{this._dead||(this._debugLog(`Load: ${t} ${e} status=${s.status}`),200==s.status?(this._debugLog("Range disabled or unsupported, complete load"),t=0,e=s.response.byteLength,this._len=e,this._buf=s.response,this._bytes=new this._Uint8Array(this._buf)):(206!=s.status&&this._error(`Unexpected HTTP status ${s.status}`),s.response.byteLength!=e&&this._error(`Unexpected length ${s.response.byteLength} (expected ${e})`),this._bytes.set(new this._Uint8Array(s.response),t)),i&&i.apply(this,[t,e]))},!1),s.addEventListener("error",this._mkerr("Fetch failed"),!1),s.open("GET",this.op.source),s.responseType="arraybuffer",null!=t&&null!=e){const i=t+e;s.setRequestHeader("Range",`bytes=${t}-${i-1}`),this._isSafari&&(s.setRequestHeader("Cache-control","no-cache"),s.setRequestHeader("If-None-Match",Math.random().toString()))}s.send()}_startLoad(){this.op.source?fetch(this.op.source,{method:"HEAD"}).then(t=>{if(this._dead)return;this._pHead=0,this._pNextHead=0,this._pFetch=0;const e=parseInt(t.headers.get("Content-Length"));if(!e)return this._debugLog("HEAD request failed: invalid file length."),this._debugLog("Falling back to full file mode."),void this._load(null,null,(t,e)=>{this._pTail=0,this._pHead=e,this._findCentralDirectory()});this._debugLog(`Len: ${e}`),this._len=e,this._buf=new this._ArrayBuffer(e),this._bytes=new this._Uint8Array(this._buf);let i=e-this._trailerBytes;i<0&&(i=0),this._pTail=e,this._load(i,e-i,t=>{this._pTail=t,this._findCentralDirectory()})}).catch(this._mkerr("Length fetch failed")):this._loadNextFrame()}_findCentralDirectory(){const t=new this._DataView(this._buf,this._len-22,22);101010256!=t.getUint32(0,!0)&&this._error("End of Central Directory signature not found");const e=t.getUint16(10,!0),i=t.getUint32(12,!0),s=t.getUint32(16,!0);s<this._pTail?this._load(s,this._pTail-s,()=>{this._pTail=s,this._readCentralDirectory(s,i,e)}):this._readCentralDirectory(s,i,e)}_readCentralDirectory(t,e,i){const s=new this._DataView(this._buf,t,e);let a=0;for(let e=0;e<i;e++){33639248!=s.getUint32(a,!0)&&this._error("Invalid Central Directory signature");const e=s.getUint16(a+10,!0),i=s.getUint32(a+24,!0),r=s.getUint16(a+28,!0),h=s.getUint16(a+30,!0),o=s.getUint16(a+32,!0),n=s.getUint32(a+42,!0);0!=e&&this._error("Unsupported compression method"),a+=46;const _=new this._Uint8Array(this._buf,t+a,r);let d="";for(let t=0;t<r;t++)d+=String.fromCharCode(_[t]);a+=r+h+o,this._files[d]={off:n,len:i}}this._pHead>=this._pTail?(this._pHead=this._len,this._loadNextFrame()):(this._loadNextChunk(),this._loadNextChunk())}_loadNextChunk(){if(this._pFetch>=this._pTail)return;const t=this._pFetch;let e=this.op.chunkSize;this._pFetch+e>this._pTail&&(e=this._pTail-this._pFetch),this._pFetch+=e,this._load(t,e,()=>{t==this._pHead?(this._pNextHead?(this._pHead=this._pNextHead,this._pNextHead=0):this._pHead=t+e,this._pHead>=this._pTail&&(this._pHead=this._len),this._loadTimer||this._loadNextFrame()):this._pNextHead=t+e,this._loadNextChunk()})}_fileDataStart(t){const e=new DataView(this._buf,t,30);return t+30+e.getUint16(26,!0)+e.getUint16(28,!0)}_isFileAvailable(t){const e=this._files[t];return e||this._error(`File ${t} not found in ZIP`),!(this._pHead<e.off+30)&&this._pHead>=this._fileDataStart(e.off)+e.len}_loadNextFrame(){if(this._dead)return;const t=this._loadFrame;if(t>=this._frameCount)return;const e=this.op.metadata.frames[t];if(!this.op.source)return this._loadFrame+=1,void this._loadImage(t,e.file,!1);if(!this._isFileAvailable(e.file))return;this._loadFrame+=1;const i=this._fileDataStart(this._files[e.file].off),s=i+this._files[e.file].len;let a;const r=this.op.metadata.mime_type||"image/png";if(this._URL){let h,o;this._buf.slice?h=this._buf.slice(i,s):(h=new this._ArrayBuffer(this._files[e.file].len),new this._Uint8Array(h).set(this._bytes.subarray(i,s)));try{o=new this._Blob([h],{type:r})}catch(t){this._debugLog(`Blob constructor failed. Trying BlobBuilder... (${t.message})`);const e=new this._BlobBuilder;e.append(h),o=e.getBlob()}a=this._URL.createObjectURL(o),this._loadImage(t,a,!0)}else a=`data:${r};base64,${function(t,e,i){let s="";const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r=new Uint8Array(t),h=i%3,o=e+i-h;let n,_,d,l,u;for(let t=e;t<o;t+=3)s+=a[n=(16515072&(u=r[t]<<16|r[t+1]<<8|r[t+2]))>>18]+a[_=(258048&u)>>12]+a[d=(4032&u)>>6]+a[l=63&u];return 1==h?s+=`${a[n=(252&(u=r[o]))>>2]+a[_=(3&u)<<4]}==`:2==h&&(s+=`${a[n=(64512&(u=r[o]<<8|r[o+1]))>>10]+a[_=(1008&u)>>4]+a[d=(15&u)<<2]}=`),s}(this._buf,i,s-i)}`,this._loadImage(t,a,!1)}_loadImage(t,e,i){const s=new Image,a=this.op.metadata.frames[t];s.addEventListener("load",()=>{this._debugLog(`Loaded ${a.file} to frame ${t}`),i&&this._URL.revokeObjectURL(e),this._dead||(this._frameImages[t]=s,0==this._loadingState&&this._displayFrame.apply(this),t>=this._frameCount-1?(this._setLoadingState(2),this._buf=null,this._bytes=null):!this._maxLoadAhead||t-this._frame<this._maxLoadAhead?this._loadNextFrame():this._loadTimer||(this._loadTimer=setTimeout(()=>{this._loadTimer=null,this._loadNextFrame()},200)))}),s.src=e}_setLoadingState(t){this._loadingState!=t&&(this._loadingState=t)}_displayFrame(){if(this._dead)return;const t=this.op.metadata.frames[this._frame];this._debugLog(`Displaying frame: ${this._frame} ${t.file}`);const e=this._frameImages[this._frame];if(!e)return this._debugLog("Image not available!"),void this._setLoadingState(0);if(2!=this._loadingState&&this._setLoadingState(1),this.op.autoscale){if(!this._rescale){this._context.canvas.width=this.op.width,this._context.canvas.height=this.op.height;const t=this.op.width/e.width;this._context.scale(t,t),this._rescale=!0}}else this.op.autosize&&(this._context.canvas.width==e.width&&this._context.canvas.height==e.height||(this._context.canvas.width=e.width,this._context.canvas.height=e.height));this._context.clearRect(0,0,this.op.canvas.width,this.op.canvas.height),this._context.drawImage(e,0,0),this._paused||(this._timer=setTimeout(()=>{this._timer=null,this._nextFrame.apply(this)},t.delay))}_nextFrame(){if(this._frame>=this._frameCount-1){if(!this.op.loop)return void this.pause();this._frame=0}else this._frame+=1;this._displayFrame()}play(){this._dead||this._paused&&(this._paused=!1,this._displayFrame())}pause(){this._dead||this._paused||(this._timer&&clearTimeout(this._timer),this._paused=!0)}rewind(){this._dead||(this._frame=0,this._timer&&clearTimeout(this._timer),this._displayFrame())}stop(){this._debugLog("Stopped!"),this._dead=!0,this._timer&&clearTimeout(this._timer),this._loadTimer&&clearTimeout(this._loadTimer),this._frameImages=null,this._buf=null,this._bytes=null}getCurrentFrame(){return this._frame}getLoadedFrames(){return this._frameImages.length}getFrameCount(){return this._frameCount}hasError(){return this._failed}}}();
